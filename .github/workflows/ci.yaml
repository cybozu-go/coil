name: CI
on:
  pull_request:
  push:
    branches:
    - 'main'
defaults:
  run:
    working-directory: v2
env:
  go-version: 1.16
  cache-version: 1
jobs:
  test:
    name: Small test
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2
    - uses: actions/setup-go@v2
      with:
        go-version: ${{ env.go-version }}
    - name: Cache tools
      id: cache-tools
      uses: actions/cache@v2
      with:
        path: |
          v2/bin
          v2/include
        key: cache-${{ env.cache-version }}-go-${{ env.go-version }}-${{ hashFiles('v2/Makefile', 'v2/common.mk') }}
    - run: make setup
      if: steps.cache-tools.outputs.cache-hit != 'true'
    - run: make test
    - run: make test-nodenet
      timeout-minutes: 10
    - run: make test-founat
      timeout-minutes: 10
    - run: make check-generate
    - name: Build coil-migrator
      run: go build .
      working-directory: coil-migrator
