{
  "ignition": { "version": "2.2.0" },
  "storage": {
    "files": [
      {
        "filesystem": "root",
        "path": "/etc/hostname",
        "mode": 420,
        "contents": { "source": "data:,@NODE_NAME@" }
      },
      {
        "filesystem": "root",
        "path": "/etc/hosts",
        "mode": 420,
        "contents": { "source": "data:,127.0.0.1%09localhost%0A::1%09%09localhost%0A%0A@NODE1@%09node1%0A@NODE2@%09node2%0A@NODE3@%09node3%0A@NODE4@%09node4%0A@NODE5@%09node5%0A@NODE6@%09node6%0A" }
      },
      {
        "filesystem": "root",
        "path": "/etc/containerd/config.toml",
        "contents": {
          "source": "data:,root%20%3D%20%22%2Fvar%2Flib%2Fcontainerd%22%0Astate%20%3D%20%22%2Frun%2Fcontainerd%22%0Aoom_score%20%3D%200%0A%5Bgrpc%5D%0A%20%20address%20%3D%20%22%2Frun%2Fdocker%2Flibcontainerd%2Fdocker-containerd.sock%22%0A%20%20uid%20%3D%200%0A%20%20gid%20%3D%200%0A%20%20max_recv_message_size%20%3D%2016777216%0A%20%20max_send_message_size%20%3D%2016777216%0A%5Bdebug%5D%0A%20%20address%20%3D%20%22%22%0A%20%20uid%20%3D%200%0A%20%20gid%20%3D%200%0A%20%20level%20%3D%20%22%22%0A%5Bmetrics%5D%0A%20%20address%20%3D%20%22%22%0A%20%20grpc_histogram%20%3D%20false%0A%5Bcgroup%5D%0A%20%20path%20%3D%20%22%22%0A%5Bplugins%5D%0A%20%20%5Bplugins.cgroups%5D%0A%20%20%20%20no_prometheus%20%3D%20false%0A%20%20%5Bplugins.cri%5D%0A%20%20%20%20stream_server_address%20%3D%20%22127.0.0.1%22%0A%20%20%20%20stream_server_port%20%3D%20%2210010%22%0A%20%20%20%20enable_selinux%20%3D%20false%0A%20%20%20%20sandbox_image%20%3D%20%22quay.io%2Fcybozu%2Fpause%3A3.1%22%0A%20%20%20%20stats_collect_period%20%3D%2010%0A%20%20%20%20systemd_cgroup%20%3D%20false%0A%20%20%20%20enable_tls_streaming%20%3D%20false%0A%20%20%20%20max_container_log_line_size%20%3D%2016384%0A%20%20%20%20%5Bplugins.cri.containerd%5D%0A%20%20%20%20%20%20snapshotter%20%3D%20%22overlayfs%22%0A%20%20%20%20%20%20%5Bplugins.cri.containerd.default_runtime%5D%0A%20%20%20%20%20%20%20%20runtime_type%20%3D%20%22io.containerd.runtime.v1.linux%22%0A%20%20%20%20%20%20%20%20runtime_engine%20%3D%20%22%22%0A%20%20%20%20%20%20%20%20runtime_root%20%3D%20%22%22%0A%20%20%20%20%20%20%5Bplugins.cri.containerd.untrusted_workload_runtime%5D%0A%20%20%20%20%20%20%20%20runtime_type%20%3D%20%22%22%0A%20%20%20%20%20%20%20%20runtime_engine%20%3D%20%22%22%0A%20%20%20%20%20%20%20%20runtime_root%20%3D%20%22%22%0A%20%20%20%20%5Bplugins.cri.cni%5D%0A%20%20%20%20%20%20bin_dir%20%3D%20%22%2Fopt%2Fcni%2Fbin%22%0A%20%20%20%20%20%20conf_dir%20%3D%20%22%2Fetc%2Fcni%2Fnet.d%22%0A%20%20%20%20%20%20conf_template%20%3D%20%22%22%0A%20%20%20%20%5Bplugins.cri.registry%5D%0A%20%20%20%20%20%20%5Bplugins.cri.registry.mirrors%5D%0A%20%20%20%20%20%20%20%20%5Bplugins.cri.registry.mirrors.%22docker.io%22%5D%0A%20%20%20%20%20%20%20%20%20%20endpoint%20%3D%20%5B%22https%3A%2F%2Fregistry-1.docker.io%22%5D%0A%20%20%20%20%20%20%20%20%5Bplugins.cri.registry.mirrors.%22quay.io%22%5D%0A%20%20%20%20%20%20%20%20%20%20endpoint%20%3D%20%5B%22https%3A%2F%2Fquay.io%22%5D%0A%20%20%5Bplugins.diff-service%5D%0A%20%20%20%20default%20%3D%20%5B%22walking%22%5D%0A%20%20%5Bplugins.linux%5D%0A%20%20%20%20shim%20%3D%20%22containerd-shim%22%0A%20%20%20%20runtime%20%3D%20%22runc%22%0A%20%20%20%20runtime_root%20%3D%20%22%22%0A%20%20%20%20no_shim%20%3D%20false%0A%20%20%20%20shim_debug%20%3D%20false%0A%20%20%5Bplugins.scheduler%5D%0A%20%20%20%20pause_threshold%20%3D%200.02%0A%20%20%20%20deletion_threshold%20%3D%200%0A%20%20%20%20mutation_threshold%20%3D%20100%0A%20%20%20%20schedule_delay%20%3D%20%220s%22%0A%20%20%20%20startup_delay%20%3D%20%22100ms%22%0A",
          "verification": {}
        },
        "mode": 420
      },
      {
        "filesystem": "root",
        "path": "/opt/bin/wait-containerd-socket",
        "contents": {
          "source": "data:,%23!%2Fbin%2Fsh%0Awhile%20!%20test%20-S%20%2Frun%2Fdocker%2Flibcontainerd%2Fdocker-containerd.sock%3B%20do%0A%20%20%20%20sleep%201%0Adone%0A",
          "verification": {}
        },
        "mode": 493
      }
    ]
  },
  "networkd": {
    "units": [{
      "name": "00-eth0.network",
      "contents": "[Match]\nName=eth0\n\n[Network]\nAddress=@NODE_ADDRESS@/24\nGateway=@BRIDGE_ADDRESS@\nDNS=8.8.8.8\nDNS=1.1.1.1"
    }]
  },
  "passwd": {
    "users": [
      {
        "name": "cybozu",
        "passwordHash": "$6$rounds=4096$m3AVOWeB$EPystoHozf.eJNCm4tWyRHpJzgTDymYuGOONWxRN8uk4amLvxwB4Pc7.tEkZdeXewoVEBEX5ujUon9wSpEf1N.",
        "sshAuthorizedKeys": [
          "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCoYNNrwXDSpa5D/vG+xN0V8/SiqCldTGXwWk4VaklZNQz1mEk2J0F+CVucABDXj/sl+9NQcBCBDtfSKHwgnZnpUMYZn2SvU3jaI3n/XvIwJnCAaBFvC2+P79fiUVRrTNUd792cvGQFDJXaE6+Us78Tt9R5XLvQy3/U12Vm0jXmXUlf/6kklVJb5hovtAXhfhphp349JBTmNFAHkox+FNJrK4AwMlz8UJhwCuqEe8L96HqVvK5DLdaiQjWn5dpFvWCLJt8VbfnKZ9VPcSwYFmOSmyBkYIx+dDkf7Gv0mIi28sTvIB2cFl6/HkPIqasL3m2+MqIMZJQt3yPgiIC+WwAv"
        ],
        "groups": ["docker", "sudo"]
      }
    ]
  },
  "systemd": {
    "units": [
      {
        "mask": true,
        "name": "update-engine.service"
      },
      {
        "mask": true,
        "name": "locksmithd.service"
      },
      {
        "name": "data.mount",
        "enable": true,
        "contents": "[Mount]\nWhat=/dev/vdb1\nWhere=/data\nType=vfat\nOptions=ro\n\n[Install]\nWantedBy=local-fs.target"
      },
      {
        "name": "bird.service",
        "enable": true,
        "contents": "[Unit]\nWants=data.mount network-online.target\nAfter=data.mount network.target network-online.target\n\n[Service]\nSlice=machine.slice\nType=simple\nKillMode=mixed\nRestart=on-failure\nExecStart=/usr/bin/rkt run --insecure-options=image --volume run,kind=empty,readOnly=false --volume etc,kind=host,source=/data/bird.conf,readOnly=true --net=host docker://quay.io/cybozu/bird:2.0 --readonly-rootfs=true --caps-retain=CAP_NET_ADMIN,CAP_NET_BIND_SERVICE,CAP_NET_RAW --name bird --mount volume=run,target=/run/bird --mount volume=etc,target=/etc/bird/bird.conf\n\n[Install]\nWantedBy=multi-user.target\n"
      },
      {
        "name": "docker.service",
        "dropins": [{
          "name": "10-docker-opts.conf",
          "contents": "[Service]\nEnvironment=DOCKER_OPTS=\"--bridge=none --iptables=false --ip-masq=false\"\n"
        }]
      },
      {
        "name": "load-coil.service",
        "enable": true,
        "contents": "[Unit]\nWants=data.mount wait-containerd-socket.service\nAfter=data.mount wait-containerd-socket.service\n\n[Service]\nType=oneshot\nExecStartPre=/usr/bin/docker load -i /data/coil.img\nExecStartPre=/usr/bin/docker save quay.io/cybozu/coil:dev -o /tmp/coil-exported.img\nExecStart=/usr/bin/ctr \\\n  --address=/run/docker/libcontainerd/docker-containerd.sock \\\n  --namespace k8s.io \\\n  cri load \\\n  /tmp/coil-exported.img\n\n[Install]\nWantedBy=multi-user.target\n"
      },
      {
        "name": "containerd.service",
        "enable": true,
        "dropins": [
            {
                "contents": "[Unit]\nConditionPathExists=/etc/containerd/config.toml\n\n[Service]\nExecStartPre=/usr/bin/mkdir -p /run/docker/libcontainerd\nExecStart=\nExecStart=/usr/bin/env PATH=${TORCX_BINDIR}:${PATH} ${TORCX_BINDIR}/containerd --config /etc/containerd/config.toml\n",
                "name": "10-opts.conf"
            }
        ]
      },
      {
        "name": "wait-containerd-socket.service",
        "enable": true,
        "contents": "[Unit]\nDescription=Wait for containerd socket\nWants=containerd.service\nAfter=containerd.service\n\n[Service]\nType=oneshot\nExecStart=/opt/bin/wait-containerd-socket\nRemainAfterExit=yes\n\n[Install]\nWantedBy=multi-user.target\n"
      }
    ]
  }
}

